<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>فال حافظ</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Amiri', serif;
            font-size: 12pt;
            margin: 0;
            padding: 0;
            direction: rtl;
            text-align: right;
        }
        #container {
            width: 700px;
            height: 800px;
            overflow: auto;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            margin: 0 auto;
            font-family: 'Amiri', serif;
        }
        #startButton {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16pt;
            cursor: pointer;
        }
        pre {
            font-family: 'Amiri', serif;
            white-space: pre-wrap;
            margin: 0;
        }
        h3 {
            font-family: 'Amiri', serif;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        hr {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <button id="startButton">فال حافظ</button>
    <div id="container"></div>
    <script>
        const startButton = document.getElementById('startButton');
        startButton.addEventListener('click', main);

        async function main() {
            startButton.disabled = true; // Disable button while processing
            const All = Array.from({length: 495}, (_, i) => i + 1);
            const Answer = All[Math.floor(Math.random() * All.length)];
            const FAAL = Answer + 2129;
            const url = `https://ganjoor.net/t6e?p=${FAAL}`;
            const URL = `https://satinmod.com/ghazal-${Answer}`;

            document.title = `غزل شمارۀ ${Answer}`;

            const content = await getWebContent(url);
            if (content.startsWith("Error")) {
                displayContent(content);
                startButton.disabled = false;
                return;
            }

            let modifiedContent = excludeElementsById(content, 't6e-footer');
            modifiedContent = excludeElements(modifiedContent, ['head', 'a', 'script']);
            const textContent = getTextFromHtml(modifiedContent).trim();

            const interpretations = await getInterpretation(URL);
            // Add Persian numbering to each interpretation paragraph
            const persianDigits = ['۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹', '۱۰'];
            const numberedInterpretations = interpretations.map((text, idx) => `${persianDigits[idx] || (idx + 1)}. ${text}`);
            const interpretationText = numberedInterpretations.join('\n\n');

            const displayHTML = `<pre>${textContent}</pre><hr><h3>تعبیر:</h3><pre>${interpretationText}</pre>`;

            displayContent(displayHTML);
            startButton.disabled = false; // Re-enable if you want to allow re-clicks
        }

        async function getWebContent(url) {
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`Status: ${response.status}`);
                }
                return await response.text();
            } catch (e) {
                return `Error fetching content: ${e.message}`;
            }
        }

        function excludeElements(htmlContent, elementsToExclude) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            elementsToExclude.forEach(tag => {
                const elements = doc.querySelectorAll(tag);
                elements.forEach(el => el.remove());
            });
            return doc.documentElement.outerHTML;
        }

        function excludeElementsById(htmlContent, idToExclude) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const divToExclude = doc.querySelector(`#${idToExclude}`);
            if (divToExclude) {
                divToExclude.remove();
            }
            return doc.documentElement.outerHTML;
        }

        async function getInterpretation(URL) {
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(URL)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    return [`Failed to fetch page. Status code: ${response.status}`];
                }
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const desiredClass = "wp-block-group.gtafsir-hafez";
                const elements = doc.querySelectorAll(`.${desiredClass}`);
                const interpretations = [];
                elements.forEach(el => {
                    interpretations.push(el.textContent.trim());
                });
                return interpretations;
            } catch (e) {
                return [`Error: ${e.message}`];
            }
        }

        function getTextFromHtml(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            return doc.body.textContent || "";
        }

        function displayContent(html) {
            const container = document.getElementById('container');
            container.innerHTML = html;
        }
    </script>
</body>
</html>
