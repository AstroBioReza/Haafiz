<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>فال حافظ</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Amiri', serif;
            font-size: 12pt;
            margin: 0;
            padding: 0;
            direction: rtl;
            text-align: right;
        }
        #container {
            width: 100vw;
            height: 100vh;
            overflow: auto;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            margin: 0;
            font-family: 'Amiri', serif;
        }
        @media (max-width: 600px) {
            #container {
                width: 100vw;
                height: auto;
                min-height: 60vh;
                max-height: 100vh;
                padding: 5px;
            }
        }
        #startButton {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16pt;
            cursor: pointer;
        }
        pre {
            font-family: 'Amiri', serif;
            white-space: pre-wrap;
            margin: 0;
        }
        h3 {
            font-family: 'Amiri', serif;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        hr {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <button id="startButton">فال حافظ</button>
    <div id="container"></div>

    <script>
        const startButton = document.getElementById('startButton');
        startButton.addEventListener('click', main);

        async function main() {
            startButton.disabled = true;

            const All = Array.from({length: 495}, (_, i) => i + 1);
            const Answer = All[Math.floor(Math.random() * All.length)];
            const FAAL = Answer + 2129;
            const url = `https://ganjoor.net/t6e?p=${FAAL}`;
            const URL = `https://satinmod.com/ghazal-${Answer}`;           // ← as in the Python code
            const paddedAnswer = String(Answer).padStart(3, '0');
            const URL2 = `https://hafez-fal.ir/ghazal/${paddedAnswer}`;

            document.title = `غزل شمارۀ ${toPersianNum(Answer)}`;

            const content = await getWebContent(url);
            if (content.startsWith("Error")) {
                displayContent(content);
                startButton.disabled = false;
                return;
            }

            let modifiedContent = excludeElementsById(content, 't6e-footer');
            modifiedContent = excludeElements(modifiedContent, ['head', 'a', 'script']);
            const textContent = getTextFromHtml(modifiedContent).trim();

            const interpretations = await getInterpretationSatinmod(URL);   // ← exact logic ported
            const interpretationHafezFal = await getInterpretationHafezFal(URL2);

            const allInterpretations = [...interpretations, interpretationHafezFal]
                .filter(t => t && t.trim() !== '' && !t.includes('تعبیری یافت نشد'));

            const persianDigits = ['۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹', '۱۰'];
            const numberedInterpretations = allInterpretations.map((text, idx) => 
                `${persianDigits[idx] || (idx + 1)}. ${text.trim()}`
            );
            const interpretationText = numberedInterpretations.join('\n\n') || 'تعبیری یافت نشد';

            const displayHTML = `
                <h2 style="text-align: center;">${document.title}</h2>
                <pre>${textContent}</pre>
                <hr>
                <h3>تعبیر:</h3>
                <pre>${interpretationText}</pre>
            `;
            displayContent(displayHTML);

            startButton.disabled = false;
        }

        function toPersianNum(num) {
            const persianDigits = '۰۱۲۳۴۵۶۷۸۹'.split('');
            return num.toString().split('').map(d => persianDigits[d]).join('');
        }

        async function getWebContent(url) {
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                return await response.text();
            } catch (e) {
                return `Error fetching content: ${e.message}`;
            }
        }

        function excludeElements(htmlContent, elementsToExclude) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            elementsToExclude.forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });
            return doc.documentElement.outerHTML;
        }

        function excludeElementsById(htmlContent, idToExclude) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const el = doc.querySelector(`#${idToExclude}`);
            if (el) el.remove();
            return doc.documentElement.outerHTML;
        }

        // ────────────────────────────────────────────────
        // This function now exactly replicates the Python logic:
        // Finds all elements with class "wp-block-group gtafsir-hafez"
        // Extracts .textContent.trim() from each
        // ────────────────────────────────────────────────
        async function getInterpretationSatinmod(URL) {
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(URL)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    return [`خطا در بارگذاری صفحه: ${response.status}`];
                }
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Exact match to Python: class_="wp-block-group gtafsir-hafez"
                // In JS → '.wp-block-group.gtafsir-hafez' (both classes required)
                const elements = doc.querySelectorAll('.wp-block-group.gtafsir-hafez');

                const interpretations = [];
                elements.forEach(el => {
                    const text = el.textContent.trim();
                    if (text) interpretations.push(text);
                });

                return interpretations.length > 0 ? interpretations : ['تعبیری یافت نشد'];

            } catch (e) {
                return [`خطا: ${e.message}`];
            }
        }

        async function getInterpretationHafezFal(URL2) {
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(URL2)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) return `خطا در بارگذاری: ${response.status}`;

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const allP = doc.querySelectorAll('p');
                for (let i = allP.length - 1; i >= 0; i--) {
                    const text = allP[i].textContent.trim();
                    if (text.length > 60 &&
                        !text.toLowerCase().includes('powered') &&
                        !text.includes('طراحی') &&
                        !text.includes('تماس') &&
                        !text.includes('mira') &&
                        !text.includes('منبع')) {
                        return text;
                    }
                }
                return 'تعبیری یافت نشد';

            } catch (e) {
                return `خطا: ${e.message}`;
            }
        }

        function getTextFromHtml(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            return doc.body.textContent.trim() || "";
        }

        function displayContent(html) {
            document.getElementById('container').innerHTML = html;
        }
    </script>
</body>
</html>